<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>짝맞추기</title>
<style>
  .card {
    display: inline-block;
    margin-right: 20px;
    margin-bottom: 20px;
    width: 70px;
    height: 100px;
    perspective: 140px;
  }

  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s;
    transform-style: preserve-3d;
  }

  .card.flipped .card-inner {
    transform: rotateY(180deg); /*회전*/
  }

  .card-front {
    background: navy;
  }

  .card-front, .card-back {
    position: absolute; /*앞면과 뒷면을 position : absolute하면 겹쳐짐*/
    width: 100%;
    height: 100%;
    border: 1px solid black;
    backface-visibility: hidden;
  }

  .card-back {
    transform: rotateY(180deg);
  }
</style>
</head>
<body>
<div id="wrapper"></div>
<script>
  const $wrapper = document.querySelector('#wrapper');
  
  const total = parseInt(prompt('카드 개수를 짝수로 입력하세요(최대 20)'));
  const colors = [
    'red', 'orange', 'yellow', 'green' ,'white',
    'pink', 'cyan', 'violet', 'gray', 'black',
  ];
  let colorslice = colors.slice(0, total/2); //colors랑 colors랑 똑같은 애 하나랑 합친다(X2) concat은 원본수정안하고 새로운 배열만들어냄
  let colorCopy = colorslice.concat(colorslice);
  let shuffled = []; //섞인 컬러들의 배열
  let clicked = []; //클릭한거
  let completed = [];
  let clickable = false;
  let startTime;

  function shuffle() {
    for (let i = 0; colorCopy.length>0; i++){
      const randomIndex = Math.floor(Math.random()*colorCopy.length);
      shuffled = shuffled.concat(colorCopy.splice(randomIndex, 1));
      //기존 배열에서 뒤에서 하나씩 합치는거니까 
    }
  }

  function createCard(i){ //div.card > div.card-inner > (div.card-front + div.card-back)
    const card = document.createElement('div'); //card는 div태그다!!
    card.className = 'card'; // .card 태그 생성
    const cardInner = document.createElement('div');
    cardInner.className = 'card-inner'; // .card-inner 태그 생성
    const cardFront = document.createElement('div');
    cardFront.className = 'card-front'; // .card-front 태그 생성
    const cardBack = document.createElement('div');
    cardBack.className = 'card-back'; // .card-back 태그 생성
    cardBack.style.backgroundColor = shuffled[i]; //카드 뒷면은 우리가 랜덤으로 섞은 컬러
    cardInner.appendChild(cardFront);
    cardInner.appendChild(cardBack);
    card.appendChild(cardInner);
    return card;
  } //팩토리함수


  //addEventListener에다가 function이면 this는 card(중요)

  //clicked : [2, 5]
  //태스크큐 : 8번 9번
  //백그라운드 : addEventListener(12), setTimeout500
  function onClickCard(){
    if (!clickable || completed.includes(this) || clicked[0] === this ){
      //클릭 플래그변수가 false일 때, 이미 클릭한 카드일때, 내가 방금 클릭한거 연달아 클릭하는거 막기
      return;
    }
    this.classList.toggle('flipped'); 
    clicked.push(this);
    if(clicked.length !== 2){ //2장 뽑은게 아니면 return
      return;
    }
    //여기서 clicked[~]은 클릭한 card를 가르킴
    clickable = false;
    const firstBackColor = clicked[0].querySelector('.card-back').style.backgroundColor;
    const secondBackColor = clicked[1].querySelector('.card-back').style.backgroundColor;
    if (firstBackColor === secondBackColor){ //두 카드가 같은 카드면
      //completed에 둘을 옮김
      completed.push(clicked[0]);
      completed.push(clicked[1]);
      clicked = []; //초기화
      clickable = true;
      if (completed.length !== total){
        return;
      }
      const endTime = new Date();
      setTimeout(()=>{ //alert가 빨리 뜨는걸 막기위해
        alert(`축하합니다! ${(endTime - startTime)/1000}초 걸렸습니다`);
        resetGame();
      }, 1000);
      return;
    }
    setTimeout(() =>{
      //다시 뒤집어놓기
      clicked[0].classList.remove('flipped'); 
      clicked[1].classList.remove('flipped'); 
      clicked = [];
      clickable = true;
    }, 500);  // 같은 카드가 아닐때 너무 빨리 뒤집힘(성질급해보임)         
  }

  function startGame(){
    clickable = false;
    shuffle();
    for(let i = 0; i < total; i += 1){
      const card = createCard(i);
      card.addEventListener('click', onClickCard); //중요
      $wrapper.appendChild(card);
    }

    // 초반 카드 공개
    document.querySelectorAll('.card').forEach((card, index) => { //모든 카드 선택
      setTimeout(() => {
        card.classList.add('flipped'); //카드마다 각각 filpped이라는 클래스를 줌
      }, 1000 + 100 * index); //카드가 하나씩 쫘르르 뒤집힘
    });
    
    // 카드 감추기
    setTimeout(() => { 
      document.querySelectorAll('.card').forEach((card) => {
        card.classList.remove('flipped'); //클래스 제거
      });
      clickable = true;
      startTime = new Date();
    }, 5000);
  }
  startGame();

  function resetGame(){
    $wrapper.innerHTML = '';
    colorCopy = colors.concat(colors);
    shuffled = [];
    completed = [];
    startGame();
  }
</script>
</body>
</html>